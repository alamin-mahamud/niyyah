---
# Middleware for HTTPS redirect
apiVersion: traefik.containo.us/v1alpha1
kind: Middleware
metadata:
  name: https-redirect
  namespace: niyyah
spec:
  redirectScheme:
    scheme: https
    permanent: true

---
# Middleware for security headers
apiVersion: traefik.containo.us/v1alpha1
kind: Middleware
metadata:
  name: security-headers
  namespace: niyyah
spec:
  headers:
    stsSeconds: 31536000
    stsIncludeSubdomains: true
    stsPreload: true
    forceSTSHeader: true
    customFrameOptionsValue: "SAMEORIGIN"
    contentTypeNosniff: true
    browserXssFilter: true
    referrerPolicy: "strict-origin-when-cross-origin"

---
# IngressRoute for niyyah.alamin.rocks (Frontend) - HTTP to HTTPS redirect
apiVersion: traefik.containo.us/v1alpha1
kind: IngressRoute
metadata:
  name: niyyah-web-http
  namespace: niyyah
spec:
  entryPoints:
    - web
  routes:
    - match: Host(`niyyah.alamin.rocks`)
      kind: Rule
      middlewares:
        - name: https-redirect
      services:
        - name: niyyah-web
          port: 80

---
# IngressRoute for niyyah.alamin.rocks (Frontend) - HTTPS
apiVersion: traefik.containo.us/v1alpha1
kind: IngressRoute
metadata:
  name: niyyah-web-https
  namespace: niyyah
spec:
  entryPoints:
    - websecure
  routes:
    - match: Host(`niyyah.alamin.rocks`)
      kind: Rule
      middlewares:
        - name: security-headers
      services:
        - name: niyyah-web
          port: 80
  tls:
    certResolver: letsencrypt

---
# IngressRoute for niyyah-api.alamin.rocks (Backend) - HTTP to HTTPS redirect
apiVersion: traefik.containo.us/v1alpha1
kind: IngressRoute
metadata:
  name: niyyah-api-http
  namespace: niyyah
spec:
  entryPoints:
    - web
  routes:
    - match: Host(`niyyah-api.alamin.rocks`)
      kind: Rule
      middlewares:
        - name: https-redirect
      services:
        - name: niyyah-api
          port: 8000

---
# IngressRoute for niyyah-api.alamin.rocks (Backend) - HTTPS
apiVersion: traefik.containo.us/v1alpha1
kind: IngressRoute
metadata:
  name: niyyah-api-https
  namespace: niyyah
spec:
  entryPoints:
    - websecure
  routes:
    - match: Host(`niyyah-api.alamin.rocks`)
      kind: Rule
      middlewares:
        - name: security-headers
      services:
        - name: niyyah-api
          port: 8000
  tls:
    certResolver: letsencrypt
